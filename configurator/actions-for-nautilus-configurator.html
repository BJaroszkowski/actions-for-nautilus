<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Actions For Nautilus Configurator</title>


	<script src="/packages/jquery.min.js"></script>
	<script src="/packages/bootstrap.min.js"></script>
	<script src="/packages/jsoneditor.js"></script>

	<link rel="stylesheet" href="/packages/jsoneditor.min.css">
	<link rel="stylesheet" href="/packages/bootstrap.min.css">
	<link rel="stylesheet" href="/packages/fontawesome.css">
	<style>
		/*
		 * A readable bas font!
		 */
		body {
			font-size: 18px !important;
			height: 100%;
			width: 100%
		}

		/*
		 * The container in general needs to be centered
		 * with some space at the top
		 */
		.container {
			margin-top: 2rem;
			left: 0;
			right: 0;
		}

		/*
		 * The title needs to be centered with a bigger font
		 */
		h3.level-1 {
			display: block !important;
			font-size: 2.3rem;
			text-align: center;
		}

		/*
		 * Submenu title doesn't need to display (it's the name of the tab!)
		 */
		div[data-schemapath$=".actions"]>h3>label {
			display: none;
		}

		/*
		 * Nor does the action name
		 */
		div.tab-pane[role="tabpanel"]>label {
			display: none;
		}

		/*
		 * Spread Basic tab property groups out a bit more
		 */
		.row>div>.form-group {
			margin-top: 1.5rem;
		}

		/*
		 * ... except the label (the first visible one)
		 */
		.row>div[data-schemapath$=".label"]>.form-group {
			margin-top: 0;
		}

		/*
		 * Mimetype, Filetype, and path_pattern row buttons are not central aligned,
		 * And we really don't need the 'TH' or the repeat of the 
		 * title in the array tab
		 */
		div[data-schemapath$=".path_patterns"] table tr td,
		div[data-schemapath$=".mimetypes"] table tr td,
		div[data-schemapath$=".filetypes"] table tr td {
			vertical-align: text-top;
		}

		div[data-schemapath$=".path_patterns"] table tr th,
		div[data-schemapath$=".mimetypes"] table tr th,
		div[data-schemapath$=".filetypes"] table tr th {
			display: none;
		}

		div[data-schemapath$=".path_patterns"]>h3>label,
		div[data-schemapath$=".mimetypes"]>h3>label,
		div[data-schemapath$=".filetypes"]>h3>label {
			visibility: collapse;
			font-size: 0;
		}

		div[data-schemapath$=".path_patterns"]>h3>label>input,
		div[data-schemapath$=".mimetypes"]>h3>label>input,
		div[data-schemapath$=".filetypes"]>h3>label>input {
			visibility: visible;
			margin: 0 !important;
		}

		/*
		 * Remove margin from the placeholder help link and make its
		 * div display inline (see javascript below for how we swap around
		 * the div and give it a class).
		 */
		.placeholder-help {
			padding-left: 1rem !important;
			margin-bottom: 0px !important;
		}

		.placeholder-help-div {
			display: inline;
		}

		/*
		 * The info buttons need some space
		 */
		.jsoneditor-twbs4-text-button {
			padding-left: 1rem !important;
			vertical-align: middle;
		}

		/*
		 * Opt-in toggles need a tooltip
		 *
		 * This is the interesting way to do it; but, in the end
		 * we simply hack the function that creates the box in order
		 * to add a title.
		 *
		input.json-editor-opt-in:hover::after {
			content: "Enable/disable optional setting in the configuration.";
			position: absolute;
			font-size: initial;
			left: 2em;
			padding: 2px 5px;
			min-width: 200px;
			color: rgb(200,200,200);
			background-color: rgb(64,64,64);
			z-index: 1;
		}
		*/

		/*
		 * Command/Menu selector box is too narrow, too low
		 * and not centered
		 */
		.a4n-action-type-chooser {
			width: 5.3rem !important;
			height: 1.94rem !important;
			vertical-align: middle !important;
		}

		/*
		 * Button groups next to labels need more space after the label
		 */
		button.json-editor-btn-collapse~label {
			padding-right: 1rem !important;
		}

		/*
		 * Card titles were to squashed
		 */
		.card-title,
		.tab-pane {
			margin-bottom: 1rem;
		}

		/*
		 * Nav labels have too greater distance between lines
		 * Line breaks that look good with the icons
		 */
		.action-command,
		.action-menu {
			padding-top: 0.1rem;
			padding-bottom: 0.4rem;
			text-indent: -0.7rem;
			padding-left: 1.7rem;
			border: 0;
			background: 0.0;
			border-radius: 0.25rem;
		}

		.action-command.active,
		.action-menu.active {
			color: #fff;
			background-color: #0d6efd;
		}

		/*
		 * Add icons to the action selectors
		 */
		.action-command i::before {
			content: "$\f054";
			font-weight: 900;
			padding-right: 0.25rem;
		}

		.action-menu i::before {
			font-weight: 900;
			padding-right: 0.5rem;
		}

		.action-menu i,
		.action-command i {
			font-size: 1rem;
		}

		.action-menu a,
		.action-command a {
			display: inline;
			padding: 0;
		}

		/*
		 * Some shading adjustments
		 */
		.card-header {
			background-color: rgba(0, 0, 0, .05);
		}

		.card-body.bg-light {
			background-color: rgba(0, 0, 0, .04) !important;
		}
	</style>
</head>

<body>

	<div class='container col-md-12'>
		<div id='editor_holder'></div>
	</div>

	<script>
		/*
		 * Because this is a local UI tightly related to
		 * backend server that it is using, unload should
		 * stop that server :)
		 */
		function onUnload(event) {
			$.ajax({
				url: '/terminate',
				type: 'post',
				data: ""
			});
		}
		addEventListener("unload", onUnload);

		/*********************
		 * *******************
		 * *******************
		 * 
		 * To get some of the behavior we want we have to extend the default
		 * Bootstrap4 theme class
		 * 
		 * *******************
		 * *******************
		 *********************/
		const iconNames = {
			"command": "fa-chevron-right",
			"menu": "fa-bars"
		}
		class a4nbootstrap4Theme extends JSONEditor.defaults.themes.bootstrap4 {
			constructor(jsoneditor) {
				super(jsoneditor)
			}

			/*
			 * We want to insert an icon before the tab selector label text 
			 * and have activation/deactivation classes associated with the 
			 * view
			 */
			getTab(text, id) {
				var element = super.getTab(text, id);
				var myEditor = this.jsoneditor.getEditor(id);
				if (/\.actions\.[0-9]+$/.test(id)) {
					var actionType = myEditor.value.type;
					var ite = document.createElement('i');
					ite.classList.add("fas")
					element.insertBefore(ite, element.firstChild);
					element.classList.add("action-" + actionType);
					element.firstChild.classList.add(iconNames[actionType]);
					myEditor.a4nActionType = actionType;
				}
				return element;
			}

			/*
			 * The theme "markTabActive" and markTabInactive functions assume that first
			 * child element in the link is the anchor ... but it's not any more - it's the <i>
			 * 
			 * So we have to "correct" those two functions - these are copies that are
			 * so-corrected
			 */
			markTabActive(row) {
				if (row.tab.classList.contains("action-command") || row.tab.classList.contains("action-menu")) {
					row.tab.firstChild.nextSibling.classList.add('active');
					row.tab.classList.add('active');
				} else {
					row.tab.firstChild.classList.add('active');
				}

				if (typeof row.rowPane !== 'undefined') {
					row.rowPane.classList.add('active');
				} else {
					row.container.classList.add('active');
				}
			}

			markTabInactive(row) {
				if (row.tab.classList.contains("action-command")
					|| row.tab.classList.contains("action-menu")) {
					row.tab.firstChild.nextSibling.classList.remove('active');
					row.tab.classList.remove('active');
				} else {
					row.tab.firstChild.classList.remove('active');
				}

				if (typeof row.rowPane !== 'undefined') {
					row.rowPane.classList.remove('active');
				} else {
					row.container.classList.remove('active');
				}
			}
		}

		/*
		 * Install the modified Bootstrap4 theme into the JSON editor so that it is
		 * instantable.
		 */
		JSONEditor.defaults.themes.a4nbootstrap4 = a4nbootstrap4Theme;

		/*********************
		 * *******************
		 * *******************
		 * 
		 * How to fiddle with the editor DOM!
		 *
		 * Without this, the help link appears under the cmd box. With it it appears to
		 * the right of the general info tooltip hoverspot. 
		 * 
		 * This puts it next to the label for the associated input
		 *
		 * "root.actions.n.command_line.container" is the container div that we see here
		 * 
		 * *******************
		 * *******************
		 *********************/

		/*
		 * Part 1
		 *
		 * Without this, the help link appears under the cmd box. With it it appears to
		 * the right of the general info tooltip hoverspot. 
		 * 
		 * This puts it next to the label for the associated input
		 *
		 * "root.actions.n.command_line.container" is the container div that we see here
		 */
		defaultStringPostBuild = JSONEditor.defaults.editors.string.prototype.postBuild;
		JSONEditor.defaults.editors.string.prototype.postBuild = function (value) {
			var returnValue = defaultStringPostBuild.bind(this)(value);
			if (this.path.endsWith(".command_line")) {
				var formGroups = this.container.getElementsByClassName("form-group");
				var helps = this.container.getElementsByClassName("placeholder-help");
				if (formGroups.length > 0 && helps.length > 0) {
					/*
					 * Get the placeholder help link container and give it a class
					 */
					var phHelpWrapper = helps[0].parentNode;
					phHelpWrapper.classList.add("placeholder-help-div")

					/*
					 * Insert it before the last element (the input element)
					 */
					formGroups[0].insertBefore(phHelpWrapper, formGroups[0].lastElementChild)

				} else {
					console.log("FAILED move the command line help link", formGroups, helps, formGroups.length, helps.length);
				}
			}
			return returnValue;
		};

		/*
		 * Part 2
		 *
		 * The tab selectors have icons and classes we can use - now we have to
		 * switch them as necessary
		 */
		defaultMultiRefreshHeaderText = JSONEditor.defaults.editors.multiple.prototype.refreshHeaderText;
		JSONEditor.defaults.editors.multiple.prototype.refreshHeaderText = function (value) {
			var returnValue = defaultMultiRefreshHeaderText.bind(this)(value);
			if (/\.actions\.[0-9]+$/.test(this.path) && this.tab) {
				var element = this.tab;
				var actionType = this.value.type;
				var existingActionType = this.a4nActionType;
				if (actionType != existingActionType) {
					if (existingActionType) {
						element.classList.remove("action-" + existingActionType);
						element.firstChild.classList.remove(iconNames[existingActionType])
					}
					element.classList.add("action-" + actionType);
					element.firstChild.classList.add(iconNames[actionType]);
				}
				this.a4nActionType = actionType;
			}
			return returnValue;
		}

		/*
		 * Part 3
		 *
		 * Action object editors also need some reordering
		 */
		defaultArrayGetElementEditor = JSONEditor.defaults.editors.array.prototype.getElementEditor;
		JSONEditor.defaults.editors.array.prototype.getElementEditor = function (value) {
			var returnValue = defaultArrayGetElementEditor.bind(this)(value);
			if (/\.actions\.[0-9]+$/.test(returnValue.path)) {
				/*
				 * THIS is the completed container that we need to swap around a bit
				 *
				 * There should be four elements:
				 *     LABEL (CSS will hide this)
				 *     SELECT (choice between menu and command
				 *     DIV (the object editor for the  menu/command)
				 *     SPAN (the buttons)
				 * 
				 * What we want is
				 *     LABEL
				 *     SPAN
				 *     SELECT
				 *     DIV
				 * 
				 * And, while we are at it, we put an a4n-specific class on the selector
				 * to make it easier to style, and add a tooltip
				 */
				if (returnValue.container.children.length == 4
					&& returnValue.container.children[0].tagName == "LABEL"
					&& returnValue.container.children[1].tagName == "SELECT"
					&& returnValue.container.children[2].tagName == "DIV"
					&& returnValue.container.children[3].tagName == "SPAN"
				) {
					returnValue.container.children[1].setAttribute("title", "Select the type of action");
					returnValue.container.children[1].classList.add("a4n-action-type-chooser");
					returnValue.container.insertBefore(returnValue.container.children[3], returnValue.container.children[1]);
				} else {
					console.log("Unexpected container layout for " + returnValue.path + " container", returnValue.container);
				}
			}
			return returnValue;
		}

		/*
		 * Part 4
		 *
		 * We want a tooltip on the opt-in checkboxes.
		 * 
		 * Complicated (but interesting) way - use an ::after:hover CSS setup
		 * Easy way: just ad a title
		 */
		const abstractEditorPrototype = Object.getPrototypeOf(JSONEditor.defaults.editors.object.prototype);
		const defaultSetOptInCheckbox = abstractEditorPrototype.setOptInCheckbox
		abstractEditorPrototype.setOptInCheckbox = function (value) {
			var returnValue = defaultSetOptInCheckbox.bind(this)(value);
			this.optInCheckbox.setAttribute("title", "Enable/disable optional setting in the configuration");
			return returnValue;
		}

		/* 
		 * Part 5
		 *
		 * Custom validator for glob and regular expression patterns. Must return an array of errors or an empty array if valid.
		 */
		JSONEditor.defaults.custom_validators.push((schema, value, path) => {
			var myValue = value;
			const errors = [];
			if (schema.format === "pattern") {
				if (myValue.startsWith("!")) {
					/*
					 * It's a negation pattern - remove for further checking
					 */
					myValue = myValue.substring(1);
				}
				if (myValue.trim().length < 1) {
					errors.push({
						path: path,
						property: 'path_patterns',
						message: 'Cannot be empty'
					});
				} else if (myValue.startsWith("re:")) {
					myValue = myValue.substring(3);
					if (myValue.trim().length < 1) {
						errors.push({
							path: path,
							property: 'path_patterns',
							message: 'Regular expression cannot be empty'
						});
					} else {
						var reError = null;
						try {
							/*
							 * Python REs and JS REs are both based on Perl REs, meaning that for
							 * all but the most complex cases they should be equivalent - so a simple
							 * "compile" here using JS RegExp should be enough to ensure that an RE
							 * is usable in the implementation (which is in python)
							 */
							new RegExp(myValue);
						} catch (e) {
							reError = e;
						}
						if (reError) {
							errors.push({
								path: path,
								property: 'path_patterns',
								message: `Invalid regular expression pattern: ${reError.message}`
							});

						}
					}
				} else {
					var globError = null;
					try {
						/*
						 * Python fnmatch is basically the same as the -wholename parameter of the UNIX find
						 * command ... and no library in JS is that simple! So we do our own home-baked conversion
						 * to a regular expression, which is, effectively:
						 * 
						 *     - . becomes \.
						 *     - * becomes .*
						 *     - ? becomes .
						 *     - [! becomes [^
						 *     - everything else remains the same
						 */
						const globRE = new RegExp("^" + myValue.replaceAll(".", "\\.").replaceAll("*", ".*").replaceAll("?", ".").replace("[!", "[^") + "$");
					} catch (e) {
						globError = e;
					}
					if (globError) {
						errors.push({
							path: path,
							property: 'path_patterns',
							message: `Invalid glob expression pattern: ${globError.message}`
						});
					}
				}
			}
			return errors;
		});
		/*********************
		 * *******************
		 * *******************
		 * 
		 * Now we are ready to configure and run
		 * 
		 * *******************
		 * *******************
		 * *******************/
		var editorConfig = {
			/*
			 * Editor options
			 */
			"array_controls_top": true,
			"disable_array_delete_last_row": true,
			"disable_collapse": true,
			"disable_edit_json": true,
			"iconlib": "fontawesome5",
			"no_additional_properties": true,
			"theme": "a4nbootstrap4",
			"keep_oneof_values": false,
			"display_required_only": false,
			"use_default_values": true,
			"disable_properties": true,
			"show_opt_in": true,
			/*
			 * Bootstrap4 theme options
			 */
			"tooltip": "browser",
			"object_indent": false,
			"table_zebrastyle": false,
			"table_border": false
		}

		var previous_values = [];
		var saved_value;
		var current_value_index = 0;
		var undo_button;
		var redo_button;
		var save_button;
		var help_button;
		var editor;


		function setUndoRedoButtonStates() {
			undo_button.disabled = (current_value_index == 0);
			redo_button.disabled = (current_value_index == (previous_values.length - 1));
		}

		function setEditorValueFromPreviousValues(editor) {
			editor.setValue(JSON.parse(previous_values[current_value_index]));
			setUndoRedoButtonStates();
		}

		function undo(e) {
			if (current_value_index > 0) {
				current_value_index--;
				setEditorValueFromPreviousValues(editor);
			}
		}

		function redo(e) {
			if (current_value_index < (previous_values.length - 1)) {
				current_value_index++;
				setEditorValueFromPreviousValues(editor);
			}
		}

		function saveConfig(e) {
			e.preventDefault();
			editor.disable();
			save_button.disabled = true;
			var errors = editor.validate();
			if (errors.length > 0) {
				alert("There are validation errors in the data");
				return;
			}
			var data = JSON.stringify(editor.getValue());
			$.ajax({
				url: '/config',
				type: 'post',
				data: data,
				headers: {
					"Content-Type": "application/json"
				},
				error: function (xh, msg, e) {
					console.error(msg, e);
					save_button.disabled = false;
					editor.enable();
					alert("An error ocurred when trying to save the configuration");
				},
				success: function (response) {
					saved_value = data;
					editor.enable();
				}
			});
		}

		function help(e) {
			console.log(e);
/*			if (helpWrapper.classList.contains("hide")) {
				helpWrapper.classList.remove("hide");
				resizer.classList.remove("hide");
				e.currentTarget.innerText = "Hide Help"
			} else {
				helpWrapper.classList.add("hide");
				resizer.classList.add("hide");
				e.currentTarget.innerText = "Show Help"
			}*/
		}

		function configChanged(e) {
			new_value = JSON.stringify(editor.getValue());
			if (previous_values[current_value_index] != new_value) {
				/*
				 * The editor changed outside of undo-redo
				 * Everything after the current index is lost
				 * then this change is pushed.
				 */
				previous_values = previous_values.slice(0, current_value_index + 1);
				current_value_index = previous_values.push(new_value) - 1;
				setUndoRedoButtonStates();
			} else {
				//console.log("Editor didn't really change!")
			}
			if (editor.validation_results.length > 0) {
				console.log(editor.validation_results);
				save_button.disabled = true
			} else {
				save_button.disabled = (new_value == saved_value)
			}
		}


		function finalizeEditorConfig(e) {
			saved_value = JSON.stringify(editor.getValue());
			previous_values[0] = saved_value;

			/*
			 * Create an undo button - icon only
			 */
			undo_button = editor.root.getButton('Undo', 'undo', 'Undo');
			undo_button.classList.add("undoredo");
			undo_button.addEventListener('click', undo);

			/*
			 * Create a redo button - icon only
			 */
			redo_button = editor.root.getButton('Redo', 'redo', 'Redo');
			redo_button.classList.add("undoredo");
			redo_button.addEventListener('click', redo);

			/*
			 * Set undo/redo button state (disabled at this point)
			 */
			setUndoRedoButtonStates();

			/*
			 * Create a save config button and disable it
			 */
			save_button = editor.root.getButton('Save', 'save', 'Save');
			save_button.addEventListener('click', saveConfig, false);
			save_button.disabled = true

			help_button = editor.root.getButton('Show Help', 'refresh', 'Show Help');
			help_button.addEventListener('click', help, false);

			/*
			 * Add the buttons to the top of the page
			 */
			var button_holder = editor.root.theme.getHeaderButtonHolder();
			button_holder.appendChild(undo_button);
			button_holder.appendChild(redo_button);
			button_holder.appendChild(save_button);
			button_holder.appendChild(help_button);
			editor.root.header.parentNode.insertBefore(button_holder, editor.root.header.nextSibling);

			/*
			 * Wire up the change watcher
			 */
			editor.on('change', configChanged);
		}

		/*
		 * Kick off page initialization
		 */
		fetch("/config")
			.then(response => {
				return response.json()
			})
			.then(config => {
				editorConfig.startval = config;
				return fetch("/schema");
			})
			.then(response => {
				return response.json()
			})
			.then(schema => {
				editorConfig.schema = schema;
				editor = new window.JSONEditor(document.querySelector("#editor_holder"), editorConfig);
				editor.on('ready', finalizeEditorConfig);
			})
			.catch(e => {
				console.log("Page initialization failed", e);
				alert("Failed to initialize the editor page");
			});
	</script>
</body>

</html>