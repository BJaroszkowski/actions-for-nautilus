<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Actions For Nautilus Configurator</title>


	<script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.0/dist/js/bootstrap.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>

	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/css/jsoneditor.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.0/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/spectre.css@latest/dist/spectre-icons.min.css">

</head>

<body>
	<div class='container'>
		<div class='col-md-12'>
			<div id='editor_holder'></div>
		</div>
	</div>

	<script>
		var a4n_config;
		var a4n_schema;
		var jeconfig;
		function onUnload(event) {
//			$.ajax({
//  				url: '/terminate',
//  				type: 'post',
//				data: ""
//			});
		}
		var previous_values = [];
		var saved_value;
		var current_value_index = 0;
		var undo_button;
		var redo_button;
		var save_button;
		var restart_button;

		function setUndoRedoButtonStates() {
			undo_button.disabled = (current_value_index == 0);
			redo_button.disabled = (current_value_index == (previous_values.length - 1));
		}

		function setEditorValueFromPreviousValues(editor) {
			editor.setValue(JSON.parse(previous_values[current_value_index]));
			setUndoRedoButtonStates();
		}

		addEventListener("unload",onUnload);
		fetch("/config")
			.then(response => {
				return response.json()
			})
			.then(config => {
				console.log(config);
				a4n_config = config;
				return fetch("/schema");
			})
			.then(response => {
				return response.json()
			})
			.then(schema => {

				// Initialize the editor
				jeconfig = {
					"ajax": true,
					"theme": "bootstrap3",
					"iconlib": "spectre",
					"object_layout": "normal",
					"template": "default",
					"show_errors": "interaction",
					"required_by_default": 0,
					"no_additional_properties": 1,
					"display_required_only": 0,
					"remove_empty_properties": 0,
					"keep_oneof_values": 0,
					"ajaxCredentials": 0,
					"show_opt_in": 0,
					"disable_edit_json": 1,
					"disable_collapse": 1,
					"disable_properties": 0,
					"disable_array_add": 0,
					"disable_array_reorder": 0,
					"disable_array_delete": 0,
					"enable_array_copy": 0,
					"array_controls_top": 1,
					"disable_array_delete_all_rows": 0,
					"disable_array_delete_last_row": 1,
					"prompt_before_delete": 1,
					"lib_aceeditor": 0,
					"lib_autocomplete": 0,
					"lib_sceditor": 0,
					"lib_simplemde": 0,
					"lib_select2": 0,
					"lib_selectize": 0,
					"lib_choices": 0,
					"lib_flatpickr": 0,
					"lib_signaturepad": 0,
					"lib_mathjs": 0,
					"lib_cleavejs": 0,
					"lib_jodit": 0,
					"lib_jquery": 0,
					"lib_dompurify": 0,
					"remove_button_labels": 0,
					"schema": schema,
					"startval": a4n_config

				}
				saved_value = JSON.stringify(a4n_config);
				previous_values[0] = saved_value;
				var editor = new window.JSONEditor(document.querySelector("#editor_holder"), jeconfig);
				editor.on('ready', function () {
					console.log(editor)
					undo_button = editor.root.getButton('Undo', 'undo', 'Undo');
					redo_button = editor.root.getButton('Redo', 'redo', 'Redo');
					save_button = editor.root.getButton('Save config', 'save', 'Save Config');
					restart_button = editor.root.getButton('Restart Nautilus', 'restart', 'Restart Nautilus');
					var button_holder = editor.root.theme.getHeaderButtonHolder();
					button_holder.appendChild(undo_button);
					button_holder.appendChild(redo_button);
					button_holder.appendChild(save_button);
					button_holder.appendChild(restart_button);
					editor.root.header.parentNode.insertBefore(button_holder, editor.root.header.nextSibling);
					save_button.addEventListener('click', function (e) {
						e.preventDefault();
						editor.disable();
						save_button.disabled = true;
						var errors  = editor.validate();
						if (errors.length > 0) {
							alert("There are validation errors in the data");
							return;
						}
						var data = JSON.stringify(editor.getValue());
						$.ajax({
  							url: '/config',
  							type: 'post',
							data: data,
							headers: {
								"Content-Type": "application/json"
							},
							error: function(xh, msg, e) {
								console.error(msg, e);
								save_button.disabled = false;
								editor.enable();
								alert("An error ocurred when trying to save the configuration");
							},
  							success: function(response) {
								saved_value = data;
								editor.enable();
  							}
						});
					}, false);
					setUndoRedoButtonStates();
					save_button.disabled = true

					restart_button.addEventListener('click', function (e) {
						e.preventDefault();
						$.ajax({
  							url: '/restart',
  							type: 'post',
							data: "",
							error: function(xh, msg, e) {
								console.error(msg, e)
							},
  							success: function(response) {
								console.log(response)
  							}
						});
					}, false);

					undo_button.addEventListener('click', function (e) {
						if (current_value_index > 0) {
							current_value_index--;
							setEditorValueFromPreviousValues(editor);
						}
					});

					redo_button.addEventListener('click', function (e) {
						if (current_value_index < (previous_values.length - 1)) {
							current_value_index++;
							setEditorValueFromPreviousValues(editor);
						}
					});
				});

				editor.on('change',() => {
					new_value = JSON.stringify(editor.getValue());
					if (previous_values[current_value_index] != new_value) {
						//console.log("Editor really changed!")
						/*
						 * The editor changed outside of undo-redo
						 * Everything after the current index is lost
						 * then this changed pushed.
						 */
						 previous_values = previous_values.slice(0,current_value_index+1);
						 current_value_index = previous_values.push(new_value) - 1;
						 setUndoRedoButtonStates();
					} else {
						//console.log("Editor didn't really change!")
					}
					if (editor.validation_results.length > 0) {
						console.log(editor.validation_results);
						save_button.disabled = true
					} else {
						save_button.disabled = (new_value == saved_value)
					}
				});

			});
	</script>
</body>

</html>