<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Actions For Nautilus Configurator</title>


	<script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@latest/dist/js/bootstrap.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/nonmin/jsoneditor.js"></script>

	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/css/jsoneditor.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@latest/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/spectre.css@latest/dist/spectre-icons.min.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css">
	<style>
		body {
			font-size: 18px !important;
		}

		/*
		 * Spread Basic tab property groups out a bit more
		 */
		.row>div>.form-group {
			margin-top: 1.5rem;
		}

		/*
		 * ... except the label (the first visible one)
		 */
		.row>div[data-schemapath$=".label"]>.form-group {
			margin-top: 0;
		}

		/*
		 * Mimetype and Filetype row buttons are not central
		 */
		div[data-schemapath$=".mimetypes"] table tr td:nth-of-type(2),
		div[data-schemapath$=".filetypes"] table tr td:nth-of-type(2) {
			padding-top: 0.47rem !important;
		}

		/*
		 * Remove margin from the placeholder help link and make its
		 * div display inline (see javascript below for how we swap around
		 * the div and give it a class).
		 */
		.placeholder-help {
			padding-left: 1rem !important;
			margin-bottom: 0px !important;
		}

		.placeholder-help-div {
			display: inline;
		}

		/*
		 * The info buttons need some space
		 */
		.jsoneditor-twbs4-text-button {
			padding-left: 1rem !important;
		}

		/*
		 * Command/Menu selector box has "Command" truncated
		 */
		div[data-schemapath*=".actions."] .je-switcher {
			width: 5.3rem !important;
		}

		/*
		 * Button groups next to labels need more space after the label
		 */
		button.json-editor-btn-collapse~label {
			padding-right: 1rem !important;
		}

		/*
		 * Card titles were to squashed
		 */
		.card-title,
		.tab-pane {
			margin-bottom: 1rem;
		}

		/*
		 * Nav labels have too greater distance between lines
		 * Line breaks that look good with the icons
		 */
		.action-command,
		.action-menu {
			padding-top: 0.1rem;
			padding-bottom: 0.4rem;
			text-indent: -0.7rem;
			padding-left: 1.7rem;
			border: 0;
			background: 0.0;
			border-radius: 0.25rem;
		}

		.action-command.active,
		.action-menu.active {
			color: #fff;
			background-color: #0d6efd;
		}

		/*
		 * A icons to the action selectors
		 */
		.action-command i::before {
			content: "$\f054";
			font-weight: 900;
			padding-right: 0.25rem;
		}

		.action-menu i::before {
			font-weight: 900;
			padding-right: 0.5rem;
		}

		.action-menu i,
		.action-command i {
			font-size: 1rem;
		}

		.action-menu a,
		.action-command a {
			display: inline;
			padding: 0;
		}

		/*
		 * The container in general needs to be centered
		 * with some space at the top
		 */
		.container {
			position: absolute;
			margin-top: 1rem;
			left: 0;
			right: 0;
		}
	</style>
</head>

<body>
	<div class='container col-md-10'>
		<div id='editor_holder'></div>
	</div>

	<script>
		/*
		 * Because this is a local UI tightly related to
		 * backend server that it is using, unload should
		 * stop that server :)
		 */
		function onUnload(event) {
			$.ajax({
				url: '/terminate',
				type: 'post',
				data: ""
			});
		}
		addEventListener("unload", onUnload);

		console.log(JSONEditor.defaults);

		/*********************
		 * *******************
		 * *******************
		 * 
		 * To get some of the behaviour we want we have to extend the default
		 * Bootstrap4 theme class
		 * 
		 * *******************
		 * *******************
		 *********************/
		const iconNames = {
			"command": "fa-chevron-right",
			"menu": "fa-bars"
		}
		class a4nbootstrap4Theme extends JSONEditor.defaults.themes.bootstrap4 {
			constructor(jsoneditor) {
				super(jsoneditor)
			}

			/*
			 * We want to insert an icon before the tab selector label text 
			 * and have activation/deactivation classes associated with the 
			 * view
			 */
			getTab (text, id) {
				var element = super.getTab(text, id);
				var myEditor = this.jsoneditor.getEditor(id);
				if (/\.actions\.[0-9]+$/.test(id)) {
					var actionType = myEditor.value.type;
//					console.log(actionType, myEditor);
					var ite = document.createElement('i');
					ite.classList.add("fas")
					element.insertBefore(ite, element.firstChild);
					element.classList.add("action-" + actionType);
					element.firstChild.classList.add(iconNames[actionType]);
					myEditor.a4nActionType = actionType;
				}
				return element;
			}

			/*
			 * The theme "markTabActive" and markTabInactive functions assume that first
			 * child element in the link is the anchor ... but it's not any more - it's the <i>
			 * 
			 * So we have to "correct" those two functions - these are copies that are
			 * so-corrected
			 */
			markTabActive (row) {
				if (row.tab.classList.contains("action-command") || row.tab.classList.contains("action-menu")) {
					row.tab.firstChild.nextSibling.classList.add('active');
					row.tab.classList.add('active');
				} else {
					row.tab.firstChild.classList.add('active');
				}

				if (typeof row.rowPane !== 'undefined') {
					row.rowPane.classList.add('active');
				} else {
					row.container.classList.add('active');
				}
			}

			markTabInactive (row) {
				if (row.tab.classList.contains("action-command")
					|| row.tab.classList.contains("action-menu")) {
					row.tab.firstChild.nextSibling.classList.remove('active');
					row.tab.classList.remove('active');
				} else {
					row.tab.firstChild.classList.remove('active');
				}

				if (typeof row.rowPane !== 'undefined') {
					row.rowPane.classList.remove('active');
				} else {
					row.container.classList.remove('active');
				}
			}
		}

		/*
		 * Install the modified Bootstrap4 theme into the JSON editor so that it is
		 * instantable.
		 */
		JSONEditor.defaults.themes.a4nbootstrap4 = a4nbootstrap4Theme;

		/*********************
		 * *******************
		 * *******************
		 * 
		 * How to fiddle with the editor DOM!
		 *
		 * Without this, the help link appears under the cmd box. With it it appears to
		 * the right of the general info tooltip hoverspot. 
		 * 
		 * This puts it next to the label for the associated input
		 *
		 * "root.actions.n.command_line.container" is the container div that we see here
		 * 
		 * *******************
		 * *******************
		 *********************/

		/*
		 * Part 1
		 *
		 * Without this, the help link appears under the cmd box. With it it appears to
		 * the right of the general info tooltip hoverspot. 
		 * 
		 * This puts it next to the label for the associated input
		 *
		 * "root.actions.n.command_line.container" is the container div that we see here
		 */
		defaultStringPostBuild = JSONEditor.defaults.editors.string.prototype.postBuild;
		JSONEditor.defaults.editors.string.prototype.postBuild = function (value) {
			var returnValue = defaultStringPostBuild.bind(this)(value);
			if (this.path.endsWith(".command_line")) {
				var formGroups = this.container.getElementsByClassName("form-group");
				var helps = this.container.getElementsByClassName("placeholder-help");
				if (formGroups.length > 0 && helps.length > 0) {
					/*
					 * Get the placeholder help link container and give it a class
					 */
					helpDiv = helps[0].parentNode;
					helpDiv.classList.add("placeholder-help-div")

					/*
					 * Insert it before the last element (the input element)
					 */
					formGroups[0].insertBefore(helpDiv, formGroups[0].lastElementChild)

				} else {
					console.log("FAILED move the command line help link", formGroups, helps, formGroups.length, helps.length);
				}
			}
			return returnValue;
		};

		/*
		 * Part 2
		 *
		 * The tab selectors have icons and classes we can use - now we have to
		 * switch them as necessary
		 */
		defaultMultiRefreshHeaderText = JSONEditor.defaults.editors.multiple.prototype.refreshHeaderText;
		JSONEditor.defaults.editors.multiple.prototype.refreshHeaderText = function (value) {
			var returnValue = defaultMultiRefreshHeaderText.bind(this)(value);
			if (/\.actions\.[0-9]+$/.test(this.path) && this.tab) {
				var element = this.tab;
				var actionType = this.value.type;
				var existingActionType = this.a4nActionType;
				//				console.log(actionType, existingActionType);
				if (actionType != existingActionType) {
					if (existingActionType) {
						element.classList.remove("action-" + existingActionType);
						element.firstChild.classList.remove(iconNames[existingActionType])
					}
					element.classList.add("action-" + actionType);
					element.firstChild.classList.add(iconNames[actionType]);
				}
				this.a4nActionType = actionType;
			}
			return returnValue;
		}

		/*********************
		 * *******************
		 * *******************
		 * 
		 * Now we are ready to configure and run
		 * 
		 * *******************
		 * *******************
		 * *******************/
		var editorConfig = {
			/*
			 * Editor options
			 */
			"array_controls_top": true,
			"disable_array_delete_last_row": true,
			"disable_collapse": true,
			"disable_edit_json": true,
			"iconlib": "fontawesome5",
			"no_additional_properties": true,
			"theme": "a4nbootstrap4",
			"keep_oneof_values": false,
			"display_required_only": false,
			"use_default_values": true,
			"disable_properties": true,
			"show_opt_in": true,
			/*
			 * Bootstrap4 theme options
			 */
			"tooltip": "browser",
			"object_indent": false,
			"table_zebrastyle": true,
			"table_border": false
		}

		var previous_values = [];
		var saved_value;
		var current_value_index = 0;
		var undo_button;
		var redo_button;
		var save_button;
		var restart_button;
		var editor;

		function setUndoRedoButtonStates() {
			undo_button.disabled = (current_value_index == 0);
			redo_button.disabled = (current_value_index == (previous_values.length - 1));
		}

		function setEditorValueFromPreviousValues(editor) {
			editor.setValue(JSON.parse(previous_values[current_value_index]));
			setUndoRedoButtonStates();
		}

		function undo(e) {
			if (current_value_index > 0) {
				current_value_index--;
				setEditorValueFromPreviousValues(editor);
			}
		}

		function redo(e) {
			if (current_value_index < (previous_values.length - 1)) {
				current_value_index++;
				setEditorValueFromPreviousValues(editor);
			}
		}

		function saveConfig(e) {
			e.preventDefault();
			editor.disable();
			save_button.disabled = true;
			var errors = editor.validate();
			if (errors.length > 0) {
				alert("There are validation errors in the data");
				return;
			}
			var data = JSON.stringify(editor.getValue());
			$.ajax({
				url: '/config',
				type: 'post',
				data: data,
				headers: {
					"Content-Type": "application/json"
				},
				error: function (xh, msg, e) {
					console.error(msg, e);
					save_button.disabled = false;
					editor.enable();
					alert("An error ocurred when trying to save the configuration");
				},
				success: function (response) {
					saved_value = data;
					editor.enable();
				}
			});
		}

		function configChanged(e) {
			new_value = JSON.stringify(editor.getValue());
			if (previous_values[current_value_index] != new_value) {
				//console.log("Editor really changed!")
				/*
				 * The editor changed outside of undo-redo
				 * Everything after the current index is lost
				 * then this change is pushed.
				 */
				previous_values = previous_values.slice(0, current_value_index + 1);
				current_value_index = previous_values.push(new_value) - 1;
				setUndoRedoButtonStates();
			} else {
				//console.log("Editor didn't really change!")
			}
			if (editor.validation_results.length > 0) {
				console.log(editor.validation_results);
				save_button.disabled = true
			} else {
				save_button.disabled = (new_value == saved_value)
			}
		}

		function finalizeEditorConfig(e) {
			console.log(editor)

			saved_value = JSON.stringify(editor.getValue());
			previous_values[0] = saved_value;

			/*
			 * Create an undo button - icon only
			 */
			undo_button = editor.root.getButton('Undo', 'undo', 'Undo');
			undo_button.classList.add("undoredo");
			undo_button.addEventListener('click', undo);

			/*
			 * Create a redo button - icon only
			 */
			redo_button = editor.root.getButton('Redo', 'redo', 'Redo');
			redo_button.classList.add("undoredo");
			redo_button.addEventListener('click', redo);

			/*
			 * Set undo/redo button state (disabled at this point)
			 */
			setUndoRedoButtonStates();

			/*
			 * Create a save config button and disable it
			 */
			save_button = editor.root.getButton('Save', 'save', 'Save');
			save_button.addEventListener('click', saveConfig, false);
			save_button.disabled = true

			/*
			 * Create a 'restart Nautilus' config button
			 *
			 * NO LONGER USED - the extension has a file-change watcher
			 * 
			restart_button = editor.root.getButton('Restart Nautilus', 'refresh', 'Restart Nautilus');
			restart_button.addEventListener('click', restartNautilus, false);
			*/

			/*
			 * Add the buttons to the top of the page
			 */
			var button_holder = editor.root.theme.getHeaderButtonHolder();
			button_holder.appendChild(undo_button);
			button_holder.appendChild(redo_button);
			button_holder.appendChild(save_button);
			//button_holder.appendChild(restart_button);
			editor.root.header.parentNode.insertBefore(button_holder, editor.root.header.nextSibling);

			/*
			 * Wire up the change watcher
			 */
			editor.on('change', configChanged);
		}

		/*
		 * Kick off page initialization
		 */
		fetch("/config")
			.then(response => {
				return response.json()
			})
			.then(config => {
				editorConfig.startval = config;
				return fetch("/schema");
			})
			.then(response => {
				return response.json()
			})
			.then(schema => {
				editorConfig.schema = schema;
				editor = new window.JSONEditor(document.querySelector("#editor_holder"), editorConfig);
				editor.on('ready', finalizeEditorConfig);
			})
			.catch(e => {
				console.log("Page initialization failed", e);
				alert("Failed to initialize the editor page");
			});
	</script>
</body>

</html>